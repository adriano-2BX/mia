<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIA - Inteligencia Imobiliaria</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- React & Babel for in-browser JSX transpilation -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Axios for API calls -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .prose { color: #334155; }
        .prose h3 { color: #1e293b; }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURAÇÃO DA API REAL ---
        const API_URL = 'https://automacoes-api.hs7hhd.easypanel.host';
        const api = axios.create({
          baseURL: API_URL,
        });

        // Interceptor para adicionar o token de autenticação em todas as requisições reais
        api.interceptors.request.use((config) => {
          const token = localStorage.getItem('accessToken');
          if (token) {
            config.headers.Authorization = `Bearer ${token}`;
          }
          return config;
        }, (error) => Promise.reject(error));


        // --- CONTEXTO DE AUTENTICAÇÃO ---
        const AuthContext = React.createContext(null);

        const AuthProvider = ({ children }) => {
          const [user, setUser] = React.useState(null);
          const [loading, setLoading] = React.useState(true);

          React.useEffect(() => {
            const checkUser = async () => {
              const token = localStorage.getItem('accessToken');
              if (token) {
                try {
                  const { data } = await api.get('/api/usuarios/me');
                  setUser(data);
                } catch (error) {
                  console.error("Sessão inválida, limpando token.", error);
                  localStorage.removeItem('accessToken');
                  setUser(null);
                }
              }
              setLoading(false);
            };
            checkUser();
          }, []);

          const login = async (email, password) => {
            const params = new URLSearchParams();
            params.append('username', email);
            params.append('password', password);
            
            const { data: tokenData } = await api.post('/api/auth/token', params, { 
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
            });
            
            localStorage.setItem('accessToken', tokenData.access_token);
            const { data: userData } = await api.get('/api/usuarios/me');
            setUser(userData);
          };

          const logout = () => {
            localStorage.removeItem('accessToken');
            setUser(null);
          };

          return <AuthContext.Provider value={{ user, loading, login, logout }}>{children}</AuthContext.Provider>;
        };

        const useAuth = () => React.useContext(AuthContext);

        // --- COMPONENTES DE UI ---
        const Button = ({ children, onClick, variant = 'primary', className = '', type = 'button', disabled = false }) => {
          const baseStyles = 'px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed';
          const variants = {
            primary: 'bg-slate-800 text-white hover:bg-slate-700 focus:ring-slate-500',
            secondary: 'bg-slate-200 text-slate-800 hover:bg-slate-300 focus:ring-slate-400',
            danger: 'bg-red-600 text-white hover:bg-red-500 focus:ring-red-500',
          };
          return <button onClick={onClick} type={type} disabled={disabled} className={`${baseStyles} ${variants[variant]} ${className}`}>{children}</button>;
        };
        const Input = ({ label, type = 'text', placeholder, value, onChange, name }) => (
            <div>
                {label && <label className="block text-sm font-medium text-slate-600 mb-1">{label}</label>}
                <input type={type} name={name} placeholder={placeholder} value={value} onChange={onChange} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-500 transition-shadow" />
            </div>
        );
        const Textarea = ({ label, placeholder, value, onChange, name, rows = 3 }) => (
            <div>
                {label && <label className="block text-sm font-medium text-slate-600 mb-1">{label}</label>}
                <textarea name={name} placeholder={placeholder} value={value} onChange={onChange} rows={rows} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-500 transition-shadow"></textarea>
            </div>
        );
        const Select = ({ label, value, onChange, name, children }) => (
            <div>
                {label && <label className="block text-sm font-medium text-slate-600 mb-1">{label}</label>}
                <select name={name} value={value} onChange={onChange} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-500 bg-white">{children}</select>
            </div>
        );
        const Card = ({ children, className = '', onClick }) => <div onClick={onClick} className={`bg-white rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1 ${onClick ? 'cursor-pointer' : ''} ${className}`}>{children}</div>;
        const Modal = ({ children, isOpen, onClose }) => {
          if (!isOpen) return null;
          return (
            <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4 animate-fade-in" onClick={onClose}>
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl relative max-h-[90vh] flex flex-col" onClick={(e) => e.stopPropagation()}>
                <button onClick={onClose} className="absolute top-4 right-4 text-slate-500 hover:text-slate-800 text-3xl z-10">&times;</button>
                <div className="overflow-y-auto">{children}</div>
              </div>
            </div>
          );
        };
        const Spinner = () => <div className="flex justify-center items-center p-10"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-slate-800"></div></div>;
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4 animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-slate-800">{title}</h3>
                        <p className="text-slate-600 mt-2 mb-6">{message}</p>
                        <div className="flex justify-end gap-4">
                            <Button variant="secondary" onClick={onClose}>Cancelar</Button>
                            <Button variant="danger" onClick={onConfirm}>Confirmar</Button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- ÍCONES SVG ---
        const BedIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 14v3m4-3v3m4-3v3M5 21h14M5 18h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v9a2 2 0 002 2z" /></svg>;
        const BathIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 6.5A2.5 2.5 0 0111.5 4h1A2.5 2.5 0 0115 6.5v0A2.5 2.5 0 0112.5 9h-1A2.5 2.5 0 019 6.5v0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 18.5V16a3 3 0 013-3h12a3 3 0 013 3v2.5" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 18.5h16" /></svg>;
        const CarIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l-2 3m4-3v13m4-13v13m4-13v13M3 19h18" /></svg>;
        const RulerIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8h16M4 16h16" /></svg>;
        const CheckIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>;
        const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
        const EditIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>;
        const UsersIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 016-6h6a6 6 0 016 6v1h-3" /></svg>;


        // --- PÁGINAS DA APLICAÇÃO ---

        const LoginPage = ({ onLoginSuccess }) => {
          const [email, setEmail] = React.useState('');
          const [password, setPassword] = React.useState('');
          const [error, setError] = React.useState('');
          const [loading, setLoading] = React.useState(false);
          const { login } = useAuth();

          const handleSubmit = async (e) => {
            e.preventDefault();
            setError('');
            setLoading(true);
            try {
              await login(email, password);
              onLoginSuccess();
            } catch (err) {
              setError('Email ou senha inválidos. Tente novamente.');
            } finally {
              setLoading(false);
            }
          };

          return (
            <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
              <div className="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl">
                <h2 className="text-3xl font-bold text-center text-slate-800 mb-2">Bem-vindo de volta</h2>
                <p className="text-center text-slate-500 mb-8">Acesse o seu workspace</p>
                <form onSubmit={handleSubmit}>
                  <div className="mb-4"><Input label="Email" type="email" placeholder="seu@email.com" value={email} onChange={(e) => setEmail(e.target.value)} /></div>
                  <div className="mb-6"><Input label="Senha" type="password" placeholder="Sua senha" value={password} onChange={(e) => setPassword(e.target.value)} /></div>
                  {error && <p className="text-red-500 text-sm text-center mb-4 break-words">{error}</p>}
                  <Button type="submit" className="w-full" disabled={loading}>{loading ? 'A entrar...' : 'Entrar'}</Button>
                </form>
              </div>
            </div>
          );
        };

        const EmpreendimentoCard = ({ empreendimento, onClick, onEdit, onDelete, canManage }) => (
          <Card className="flex flex-col">
            <div onClick={onClick} className="cursor-pointer">
                <div className="h-48 bg-slate-200">
                    <img src={empreendimento.arquivos?.[0]?.link_arquivo || 'https://placehold.co/400x300/e2e8f0/64748b?text=Sem+Imagem'} alt={`Fachada de ${empreendimento.emp_nome}`} className="w-full h-full object-cover"/>
                </div>
                <div className="p-5 flex-grow">
                    <span className="inline-block bg-slate-100 text-slate-600 text-xs font-semibold px-2 py-1 rounded-full mb-2 uppercase">{empreendimento.emp_status.replace(/_/g, ' ')}</span>
                    <h3 className="font-bold text-xl text-slate-800 mb-1">{empreendimento.emp_nome}</h3>
                    <p className="text-slate-500 text-sm">{empreendimento.emp_endereco}</p>
                </div>
            </div>
            {canManage && (
                <div className="p-3 bg-slate-50 border-t flex justify-end gap-2">
                    <button onClick={(e) => { e.stopPropagation(); onEdit(); }} className="p-2 text-slate-500 hover:text-slate-800"><EditIcon /></button>
                    <button onClick={(e) => { e.stopPropagation(); onDelete(); }} className="p-2 text-red-500 hover:text-red-700"><TrashIcon /></button>
                </div>
            )}
          </Card>
        );

        const ImageSlider = ({ arquivos }) => {
            const [currentIndex, setCurrentIndex] = React.useState(0);
            const images = arquivos?.filter(a => a.tipo.startsWith('imagem')) || [];
            if (images.length === 0) return <div className="w-full h-64 md:h-80 bg-slate-200 rounded-lg flex items-center justify-center text-slate-500">Sem Imagens</div>;
            const goToPrevious = () => setCurrentIndex(prev => (prev === 0 ? images.length - 1 : prev - 1));
            const goToNext = () => setCurrentIndex(prev => (prev === images.length - 1 ? 0 : prev + 1));
            return (
                <div className="w-full h-64 md:h-80 bg-slate-200 rounded-lg overflow-hidden relative group">
                    <img src={images[currentIndex].link_arquivo} alt={`Imagem ${currentIndex + 1}`} className="w-full h-full object-cover transition-transform duration-500 ease-in-out" />
                    {images.length > 1 && (
                        <>
                            <button onClick={goToPrevious} className="absolute top-1/2 left-2 -translate-y-1/2 bg-black/30 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">&lt;</button>
                            <button onClick={goToNext} className="absolute top-1/2 right-2 -translate-y-1/2 bg-black/30 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">&gt;</button>
                        </>
                    )}
                </div>
            );
        };

        const EmpreendimentoDetailModal = ({ empreendimento, isOpen, onClose }) => {
            if (!isOpen) return null;
            const formatCurrency = (value) => value ? new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value) : 'Consulte';
            const DetailSection = ({ title, children }) => <div className="mt-8"><h3 className="text-lg font-bold text-slate-800 border-b pb-2 mb-4">{title}</h3>{children}</div>;
            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <div className="p-6 md:p-8">
                        <ImageSlider arquivos={empreendimento.arquivos} />
                        <div className="mt-6"><span className="inline-block bg-slate-100 text-slate-600 text-xs font-semibold px-2 py-1 rounded-full mb-2 uppercase">{empreendimento.emp_status.replace(/_/g, ' ')}</span><h2 className="text-3xl font-bold text-slate-800">{empreendimento.emp_nome}</h2><p className="text-slate-500 mt-1">{empreendimento.emp_endereco}</p></div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 my-6 text-sm">
                            {empreendimento.emp_suites && <div className="flex items-center"><BedIcon /> {empreendimento.emp_suites} Suítes</div>}
                            {empreendimento.emp_banheiros && <div className="flex items-center"><BathIcon /> {empreendimento.emp_banheiros} Banheiros</div>}
                            {empreendimento.emp_vagas && <div className="flex items-center"><CarIcon /> {empreendimento.emp_vagas} Vagas</div>}
                            {empreendimento.emp_metragens && <div className="flex items-center"><RulerIcon /> {empreendimento.emp_metragens}</div>}
                        </div>
                        <div className="bg-slate-100 p-4 rounded-lg text-center"><p className="text-sm text-slate-600">A partir de</p><p className="text-3xl font-bold text-slate-800">{formatCurrency(empreendimento.valor_inicial)}</p></div>
                        <DetailSection title="Sobre o empreendimento"><p className="text-slate-600 leading-relaxed">{empreendimento.emp_descricao || 'Descrição não disponível.'}</p></DetailSection>
                        <div className="grid md:grid-cols-2 gap-8">
                            {empreendimento.emp_diferenciais && <DetailSection title="Diferenciais"><ul className="space-y-2">{empreendimento.emp_diferenciais.map(item => <li key={item} className="flex items-start"><CheckIcon /> <span className="flex-1">{item}</span></li>)}</ul></DetailSection>}
                            {empreendimento.emp_itens_de_lazer && <DetailSection title="Lazer e Conveniência"><ul className="space-y-2">{empreendimento.emp_itens_de_lazer.map(item => <li key={item} className="flex items-start"><CheckIcon /> <span className="flex-1">{item}</span></li>)}</ul></DetailSection>}
                        </div>
                        <DetailSection title="Ficha Técnica">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm">
                                <div className="flex justify-between border-b pb-2"><span className="text-slate-500">Construtora</span><span className="font-semibold text-slate-800">{empreendimento.emp_construtora || '-'}</span></div>
                                <div className="flex justify-between border-b pb-2"><span className="text-slate-500">Incorporadora</span><span className="font-semibold text-slate-800">{empreendimento.emp_incorporadora || '-'}</span></div>
                                <div className="flex justify-between border-b pb-2"><span className="text-slate-500">Arquitetura</span><span className="font-semibold text-slate-800">{empreendimento.emp_arquitetura || '-'}</span></div>
                                <div className="flex justify-between border-b pb-2"><span className="text-slate-500">Nº de Torres</span><span className="font-semibold text-slate-800">{empreendimento.numero_torres || '-'}</span></div>
                            </div>
                        </DetailSection>
                    </div>
                </Modal>
            );
        };


        const CatalogPage = ({ onEmpreendimentoClick }) => {
            const [empreendimentos, setEmpreendimentos] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            React.useEffect(() => {
                const fetchEmpreendimentos = async () => {
                    try {
                        const { data } = await api.get('/api/imobiliarias/');
                        const empreendimentosPromises = data.map(imob => api.get(`/api/imobiliarias/${imob.id}`));
                        const imobiliariasCompletas = await Promise.all(empreendimentosPromises);
                        const allEmpreendimentos = imobiliariasCompletas.flatMap(response => response.data.empreendimentos || []);
                        setEmpreendimentos(allEmpreendimentos);
                    } catch (error) { console.error("Falha ao buscar empreendimentos", error); }
                    finally { setLoading(false); }
                };
                fetchEmpreendimentos();
            }, []);
            return (
                <div className="bg-slate-50 min-h-screen">
                    <div className="container mx-auto px-4 py-12">
                        <h1 className="text-4xl md:text-5xl font-bold text-center text-slate-800 mb-4">Empreendimentos</h1>
                        <p className="text-lg text-center text-slate-500 mb-12 max-w-2xl mx-auto">Descubra os melhores lançamentos e oportunidades do mercado imobiliário.</p>
                        {loading ? <Spinner /> : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                {empreendimentos.length > 0 ? empreendimentos.map(emp => <EmpreendimentoCard key={emp.id} empreendimento={emp} onClick={() => onEmpreendimentoClick(emp)} />) : <p className="text-center col-span-full text-slate-500 py-10">Nenhum empreendimento encontrado.</p>}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const EmpreendimentoForm = ({ empreendimento, onFormSubmit, onCancel }) => {
            const { user } = useAuth();
            const [formData, setFormData] = React.useState({
                imobiliaria_id: user.imobiliaria_id,
                emp_nome: empreendimento?.emp_nome || '', emp_apelido: empreendimento?.emp_apelido || '',
                emp_status: empreendimento?.emp_status || 'lancamento', emp_endereco: empreendimento?.emp_endereco || '',
                regiao: empreendimento?.regiao || '', emp_descricao: empreendimento?.emp_descricao || '',
                emp_itens_de_lazer: (empreendimento?.emp_itens_de_lazer || []).join(', '),
                emp_locais_proximos: (empreendimento?.emp_locais_proximos || []).join(', '),
                emp_metragens: empreendimento?.emp_metragens || '', emp_suites: empreendimento?.emp_suites || '',
                emp_banheiros: empreendimento?.emp_banheiros || '', emp_vagas: empreendimento?.emp_vagas || '',
                emp_diferenciais: (empreendimento?.emp_diferenciais || []).join(', '),
                emp_arquitetura: empreendimento?.emp_arquitetura || '', emp_construtora: empreendimento?.emp_construtora || '',
                emp_incorporadora: empreendimento?.emp_incorporadora || '', numero_torres: empreendimento?.numero_torres || '',
                numero_apartamentos: empreendimento?.numero_apartamentos || '', area_terreno: empreendimento?.area_terreno || '',
                area_construcao: empreendimento?.area_construcao || '', valor_inicial: empreendimento?.valor_inicial || '',
                valor_final: empreendimento?.valor_final || '', emp_previsao: empreendimento?.emp_previsao || '',
                emp_link_publico: empreendimento?.emp_link_publico || '',
                arquivos: empreendimento?.arquivos || [],
            });

            const handleChange = (e) => setFormData({...formData, [e.target.name]: e.target.value});
            
            const handleFileChange = (index, event) => {
                const newFiles = [...formData.arquivos];
                newFiles[index][event.target.name] = event.target.value;
                setFormData({...formData, arquivos: newFiles});
            };

            const addFile = () => {
                setFormData({...formData, arquivos: [...formData.arquivos, { tipo: 'imagem_interna', link_arquivo: '', ordem: formData.arquivos.length + 1 }]});
            };

            const removeFile = (index) => {
                const newFiles = formData.arquivos.filter((_, i) => i !== index);
                setFormData({...formData, arquivos: newFiles});
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const processedData = {
                    ...formData,
                    emp_itens_de_lazer: formData.emp_itens_de_lazer.split(',').map(item => item.trim()).filter(Boolean),
                    emp_locais_proximos: formData.emp_locais_proximos.split(',').map(item => item.trim()).filter(Boolean),
                    emp_diferenciais: formData.emp_diferenciais.split(',').map(item => item.trim()).filter(Boolean),
                };
                onFormSubmit(processedData);
            };

            return (
                <div className="p-6 md:p-8">
                    <form onSubmit={handleSubmit}>
                        <h2 className="text-2xl font-bold mb-6">{empreendimento ? 'Editar' : 'Novo'} Empreendimento</h2>
                        <div className="space-y-6">
                            <fieldset className="border p-4 rounded-lg"><legend className="px-2 font-semibold text-slate-700">Informações Básicas</legend>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <Input label="Nome do Empreendimento" name="emp_nome" value={formData.emp_nome} onChange={handleChange} />
                                    <Input label="Apelido" name="emp_apelido" value={formData.emp_apelido} onChange={handleChange} />
                                    <Select label="Status" name="emp_status" value={formData.emp_status} onChange={handleChange}>
                                        <option value="lancamento">Lançamento</option><option value="em_obras">Em Obras</option>
                                        <option value="pronto_para_morar">Pronto para Morar</option><option value="entregue">Entregue</option>
                                    </Select>
                                    <Input label="Região" name="regiao" value={formData.regiao} onChange={handleChange} />
                                    <div className="md:col-span-2"><Input label="Endereço Completo" name="emp_endereco" value={formData.emp_endereco} onChange={handleChange} /></div>
                                    <div className="md:col-span-2"><Textarea label="Descrição" name="emp_descricao" value={formData.emp_descricao} onChange={handleChange} rows={4} /></div>
                                </div>
                            </fieldset>
                            <fieldset className="border p-4 rounded-lg"><legend className="px-2 font-semibold text-slate-700">Detalhes do Imóvel</legend>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <Input label="Metragens" name="emp_metragens" value={formData.emp_metragens} onChange={handleChange} />
                                    <Input label="Suítes" name="emp_suites" value={formData.emp_suites} onChange={handleChange} />
                                    <Input label="Banheiros" name="emp_banheiros" value={formData.emp_banheiros} onChange={handleChange} />
                                    <Input label="Vagas" name="emp_vagas" value={formData.emp_vagas} onChange={handleChange} />
                                </div>
                            </fieldset>
                            <fieldset className="border p-4 rounded-lg"><legend className="px-2 font-semibold text-slate-700">Características</legend>
                                <div className="space-y-4">
                                   <Textarea label="Itens de Lazer (separados por vírgula)" name="emp_itens_de_lazer" value={formData.emp_itens_de_lazer} onChange={handleChange} />
                                   <Textarea label="Diferenciais (separados por vírgula)" name="emp_diferenciais" value={formData.emp_diferenciais} onChange={handleChange} />
                                   <Textarea label="Locais Próximos (separados por vírgula)" name="emp_locais_proximos" value={formData.emp_locais_proximos} onChange={handleChange} />
                                </div>
                            </fieldset>
                            <fieldset className="border p-4 rounded-lg"><legend className="px-2 font-semibold text-slate-700">Estrutura e Valores</legend>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <Input label="Nº de Torres" name="numero_torres" type="number" value={formData.numero_torres} onChange={handleChange} />
                                    <Input label="Nº de Apartamentos" name="numero_apartamentos" type="number" value={formData.numero_apartamentos} onChange={handleChange} />
                                    <Input label="Valor Inicial (R$)" name="valor_inicial" type="number" value={formData.valor_inicial} onChange={handleChange} />
                                    <Input label="Valor Final (R$)" name="valor_final" type="number" value={formData.valor_final} onChange={handleChange} />
                                    <Input label="Previsão de Entrega" name="emp_previsao" type="date" value={formData.emp_previsao} onChange={handleChange} />
                                </div>
                            </fieldset>
                            <fieldset className="border p-4 rounded-lg"><legend className="px-2 font-semibold text-slate-700">Arquivos</legend>
                                {formData.arquivos.map((file, index) => (
                                    <div key={index} className="grid grid-cols-1 md:grid-cols-3 gap-2 items-end border-b pb-4 mb-4">
                                        <Select label="Tipo" name="tipo" value={file.tipo} onChange={(e) => handleFileChange(index, e)}>
                                            <option value="imagem_fachada">Imagem (Fachada)</option>
                                            <option value="imagem_interna">Imagem (Interna)</option>
                                            <option value="planta">Planta</option>
                                            <option value="video">Vídeo</option>
                                            <option value="tour_360">Tour 360</option>
                                        </Select>
                                        <div className="md:col-span-2 grid grid-cols-3 gap-2">
                                          <div className="col-span-2"><Input label="Link do Arquivo" name="link_arquivo" value={file.link_arquivo} onChange={(e) => handleFileChange(index, e)} /></div>
                                          <Button variant="danger" onClick={() => removeFile(index)} className="self-end"><TrashIcon /></Button>
                                        </div>
                                    </div>
                                ))}
                                <Button type="button" variant="secondary" onClick={addFile}>+ Adicionar Arquivo</Button>
                            </fieldset>
                        </div>
                        <div className="flex justify-end gap-4 mt-8">
                            <Button type="button" variant="secondary" onClick={onCancel}>Cancelar</Button>
                            <Button type="submit" variant="primary">Salvar Empreendimento</Button>
                        </div>
                    </form>
                </div>
            );
        };

        const UserForm = ({ userToEdit, onFormSubmit, onCancel, imobiliariaId }) => {
            const [formData, setFormData] = React.useState({
                usu_nome: userToEdit?.usu_nome || '', 
                usu_email: userToEdit?.usu_email || '', 
                usu_senha: '', 
                permissao: userToEdit?.permissao || 'usuario', 
                imobiliaria_id: imobiliariaId
            });
            const handleChange = (e) => setFormData({...formData, [e.target.name]: e.target.value});
            const handleSubmit = (e) => { e.preventDefault(); onFormSubmit(formData); };

            return (
                <div className="p-6 md:p-8">
                    <form onSubmit={handleSubmit}>
                        <h2 className="text-2xl font-bold mb-6">{userToEdit ? 'Editar' : 'Novo'} Utilizador</h2>
                        <div className="space-y-4">
                            <Input label="Nome Completo" name="usu_nome" value={formData.usu_nome} onChange={handleChange} />
                            <Input label="Email" name="usu_email" type="email" value={formData.usu_email} onChange={handleChange} />
                            <Input label="Senha" name="usu_senha" type="password" placeholder={userToEdit ? 'Deixe em branco para não alterar' : 'Senha provisória'} value={formData.usu_senha} onChange={handleChange} />
                            <Select label="Permissão" name="permissao" value={formData.permissao} onChange={handleChange}>
                                <option value="usuario">Utilizador (Corretor)</option>
                                <option value="admin">Administrador</option>
                            </Select>
                        </div>
                        <div className="flex justify-end gap-4 mt-8">
                            <Button type="button" variant="secondary" onClick={onCancel}>Cancelar</Button>
                            <Button type="submit" variant="primary">Salvar</Button>
                        </div>
                    </form>
                </div>
            );
        };

        const ImobiliariaDashboard = ({ onEmpreendimentoClick }) => {
            const { user } = useAuth();
            const [workspaceData, setWorkspaceData] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [empreendimentoForm, setEmpreendimentoForm] = React.useState({ isOpen: false, data: null });
            const [userForm, setUserForm] = React.useState({ isOpen: false, data: null });
            const [confirmModal, setConfirmModal] = React.useState({ isOpen: false, data: null, type: '' });
            const [activeTab, setActiveTab] = React.useState('empreendimentos');

            const fetchWorkspaceData = async () => {
                if (!user || !user.imobiliaria_id) return;
                setLoading(true);
                try {
                    const { data } = await api.get(`/api/imobiliarias/${user.imobiliaria_id}`);
                    setWorkspaceData(data);
                } catch (error) { console.error("Erro ao carregar dados do workspace", error); }
                finally { setLoading(false); }
            };

            React.useEffect(() => { fetchWorkspaceData(); }, [user]);
            
            const handleEmpreendimentoSubmit = async (formData) => {
                try {
                    if (empreendimentoForm.data) { // Edit
                        await api.put(`/api/empreendimentos/${empreendimentoForm.data.id}`, formData);
                    } else { // Create
                        await api.post('/api/empreendimentos/', formData);
                    }
                    setEmpreendimentoForm({ isOpen: false, data: null });
                    fetchWorkspaceData();
                } catch (error) { console.error("Erro ao salvar empreendimento", error); }
            };

            const handleDeleteEmpreendimento = async () => {
                try {
                    await api.delete(`/api/empreendimentos/${confirmModal.data.id}`);
                    setConfirmModal({ isOpen: false, data: null, type: '' });
                    fetchWorkspaceData();
                } catch (error) { console.error("Erro ao apagar empreendimento", error); }
            };

            const handleUserSubmit = async (formData) => {
                try {
                    if (userForm.data) { // Edit
                        await api.put(`/api/usuarios/${userForm.data.id}`, formData);
                    } else { // Create
                        await api.post('/api/usuarios/', formData);
                    }
                    setUserForm({ isOpen: false, data: null });
                    fetchWorkspaceData();
                } catch (error) { console.error("Erro ao salvar utilizador", error); }
            };
            
            const handleDeleteUser = async () => {
                try {
                    await api.delete(`/api/usuarios/${confirmModal.data.id}`);
                    setConfirmModal({ isOpen: false, data: null, type: '' });
                    fetchWorkspaceData();
                } catch (error) { console.error("Erro ao apagar utilizador", error); }
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center"><Spinner /></div>;
            if (!workspaceData) return <div className="p-10 text-center text-slate-500">Não foi possível carregar os dados do workspace.</div>;
            
            const TabButton = ({ tabName, label }) => <button onClick={() => setActiveTab(tabName)} className={`px-4 py-2 rounded-t-lg text-sm font-semibold ${activeTab === tabName ? 'bg-white text-slate-800' : 'bg-transparent text-slate-500 hover:bg-slate-200'}`}>{label}</button>;

            return (
                <div className="container mx-auto px-4 py-12">
                    <div className="flex flex-wrap justify-between items-center gap-4 mb-6">
                        <div><h1 className="text-3xl font-bold text-slate-800">{workspaceData.imob_nome}</h1><p className="text-slate-500">Bem-vindo(a), {user.usu_nome}!</p></div>
                    </div>
                    <div className="border-b border-slate-200"><TabButton tabName="empreendimentos" label="Empreendimentos" />{user.permissao === 'admin' && <TabButton tabName="utilizadores" label="Utilizadores" />}</div>
                    <div className="bg-white p-6 rounded-b-2xl rounded-tr-2xl shadow-lg">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-semibold">{activeTab === 'empreendimentos' ? 'Seus Empreendimentos' : 'Sua Equipa'}</h2>
                            {user.permissao === 'admin' && activeTab === 'empreendimentos' && <Button onClick={() => setEmpreendimentoForm({ isOpen: true, data: null })}>+ Novo Empreendimento</Button>}
                            {user.permissao === 'admin' && activeTab === 'utilizadores' && <Button onClick={() => setUserForm({ isOpen: true, data: null })}>+ Novo Utilizador</Button>}
                        </div>
                        {activeTab === 'empreendimentos' && (
                            workspaceData.empreendimentos.length > 0 ? (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {workspaceData.empreendimentos.map(emp => <EmpreendimentoCard key={emp.id} empreendimento={emp} onClick={() => onEmpreendimentoClick(emp)} canManage={user.permissao === 'admin'} onEdit={() => setEmpreendimentoForm({ isOpen: true, data: emp })} onDelete={() => setConfirmModal({ isOpen: true, data: emp, type: 'empreendimento' })} />)}
                                </div>
                            ) : <div className="text-center py-10 border-2 border-dashed border-slate-200 rounded-lg"><p className="text-slate-500">Nenhum empreendimento cadastrado.</p></div>
                        )}
                        {activeTab === 'utilizadores' && (
                             workspaceData.usuarios.length > 0 ? (
                                <div className="divide-y divide-slate-100">
                                    {workspaceData.usuarios.map(u => (
                                        <div key={u.id} className="py-3 flex justify-between items-center">
                                            <div><p className="font-semibold text-slate-800">{u.usu_nome}</p><p className="text-sm text-slate-500">{u.usu_email}</p></div>
                                            <div className="flex items-center gap-2">
                                                <span className="px-2 py-1 text-xs font-medium rounded-full bg-slate-100 text-slate-700 capitalize">{u.permissao}</span>
                                                <button onClick={() => setUserForm({ isOpen: true, data: u })} className="p-2 text-slate-500 hover:text-slate-800"><EditIcon /></button>
                                                <button onClick={() => setConfirmModal({ isOpen: true, data: u, type: 'user' })} className="p-2 text-red-500 hover:text-red-700"><TrashIcon /></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : <div className="text-center py-10 border-2 border-dashed border-slate-200 rounded-lg"><p className="text-slate-500">Nenhum utilizador na sua equipa.</p></div>
                        )}
                    </div>
                    <Modal isOpen={empreendimentoForm.isOpen} onClose={() => setEmpreendimentoForm({ isOpen: false, data: null })}>
                        <EmpreendimentoForm empreendimento={empreendimentoForm.data} onFormSubmit={handleEmpreendimentoSubmit} onCancel={() => setEmpreendimentoForm({ isOpen: false, data: null })} />
                    </Modal>
                    <Modal isOpen={userForm.isOpen} onClose={() => setUserForm({ isOpen: false, data: null })}>
                        <UserForm userToEdit={userForm.data} onFormSubmit={handleUserSubmit} onCancel={() => setUserForm({ isOpen: false, data: null })} imobiliariaId={user.imobiliaria_id} />
                    </Modal>
                    <ConfirmationModal 
                        isOpen={confirmModal.isOpen} 
                        onClose={() => setConfirmModal({ isOpen: false, data: null, type: '' })}
                        onConfirm={confirmModal.type === 'empreendimento' ? handleDeleteEmpreendimento : handleDeleteUser}
                        title={`Apagar ${confirmModal.type === 'empreendimento' ? 'Empreendimento' : 'Utilizador'}`}
                        message={`Tem a certeza que quer apagar "${confirmModal.data?.emp_nome || confirmModal.data?.usu_nome}"? Esta ação não pode ser desfeita.`}
                    />
                </div>
            );
        };

        const ImobiliariaForm = ({ imobiliaria, onFormSubmit, onCancel }) => {
            const [formData, setFormData] = React.useState({ 
                imob_nome: imobiliaria?.imob_nome || '', 
                imob_creci_juridico: imobiliaria?.imob_creci_juridico || '',
                admin_nome: '',
                admin_email: '',
                admin_senha: '',
            });
            const handleChange = (e) => setFormData({...formData, [e.target.name]: e.target.value });
            const handleSubmit = (e) => { e.preventDefault(); onFormSubmit(formData); };
            return (
                <div className="p-6 md:p-8">
                    <form onSubmit={handleSubmit}>
                        <h2 className="text-2xl font-bold mb-6">{imobiliaria ? 'Editar' : 'Nova'} Imobiliária</h2>
                        <div className="space-y-6">
                            <fieldset className="border p-4 rounded-lg"><legend className="px-2 font-semibold text-slate-700">Dados da Imobiliária</legend>
                                <div className="space-y-4">
                                    <Input label="Nome da Imobiliária" name="imob_nome" value={formData.imob_nome} onChange={handleChange} />
                                    <Input label="CRECI Jurídico" name="imob_creci_juridico" value={formData.imob_creci_juridico} onChange={handleChange} />
                                </div>
                            </fieldset>
                            {!imobiliaria && (
                                <fieldset className="border p-4 rounded-lg"><legend className="px-2 font-semibold text-slate-700">Dados do Administrador</legend>
                                    <div className="space-y-4">
                                        <Input label="Nome do Admin" name="admin_nome" value={formData.admin_nome} onChange={handleChange} />
                                        <Input label="Email do Admin" name="admin_email" type="email" value={formData.admin_email} onChange={handleChange} />
                                        <Input label="Senha do Admin" name="admin_senha" type="password" value={formData.admin_senha} onChange={handleChange} />
                                    </div>
                                </fieldset>
                            )}
                        </div>
                        <div className="flex justify-end gap-4 mt-8">
                            <Button type="button" variant="secondary" onClick={onCancel}>Cancelar</Button>
                            <Button type="submit" variant="primary">Salvar</Button>
                        </div>
                    </form>
                </div>
            );
        };

        const SuperAdminDashboard = () => {
            const { user } = useAuth();
            const [imobiliarias, setImobiliarias] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [formModal, setFormModal] = React.useState({ isOpen: false, data: null });
            const [confirmModal, setConfirmModal] = React.useState({ isOpen: false, data: null });
            const [userManagementModal, setUserManagementModal] = React.useState({ isOpen: false, imobiliaria: null });

            const fetchImobiliarias = async () => {
                setLoading(true);
                try {
                    const { data } = await api.get('/api/imobiliarias/');
                    setImobiliarias(data);
                } catch (error) { console.error("Erro ao buscar imobiliárias", error); }
                finally { setLoading(false); }
            };

            React.useEffect(() => { fetchImobiliarias(); }, []);

            const handleFormSubmit = async (formData) => {
                try {
                    if (formModal.data) { // Edit
                        await api.put(`/api/imobiliarias/${formModal.data.id}`, formData);
                    } else { // Create
                        const { data: newImob } = await api.post('/api/imobiliarias/', {
                            imob_nome: formData.imob_nome,
                            imob_creci_juridico: formData.imob_creci_juridico
                        });
                        await api.post('/api/usuarios/', {
                            usu_nome: formData.admin_nome,
                            usu_email: formData.admin_email,
                            usu_senha: formData.admin_senha,
                            permissao: 'admin',
                            imobiliaria_id: newImob.id
                        });
                    }
                    setFormModal({ isOpen: false, data: null });
                    fetchImobiliarias();
                } catch (error) { console.error("Erro ao salvar imobiliária", error); }
            };

            const handleDelete = async () => {
                try {
                    await api.delete(`/api/imobiliarias/${confirmModal.data.id}`);
                    setConfirmModal({ isOpen: false, data: null });
                    fetchImobiliarias();
                } catch (error) { console.error("Erro ao apagar imobiliária", error); }
            };

            return (
                <div className="container mx-auto px-4 py-12">
                    <div className="flex flex-wrap justify-between items-center gap-4 mb-10">
                        <div><h1 className="text-3xl font-bold text-slate-800">Painel Super Admin</h1><p className="text-slate-500">Bem-vindo(a), {user.usu_nome}.</p></div>
                        <Button onClick={() => setFormModal({ isOpen: true, data: null })}>+ Nova Imobiliária</Button>
                    </div>
                    <div className="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 className="text-xl font-semibold mb-4">Imobiliárias Cadastradas</h2>
                        {loading ? <Spinner /> : (
                            <div className="divide-y divide-slate-100">
                                {imobiliarias.map(imob => (
                                    <div key={imob.id} className="py-3 flex justify-between items-center">
                                        <div><p className="font-semibold text-slate-800">{imob.imob_nome}</p><p className="text-sm text-slate-500">CRECI: {imob.imob_creci_juridico || 'N/A'}</p></div>
                                        <div className="flex items-center gap-2">
                                            <button onClick={() => setUserManagementModal({ isOpen: true, imobiliaria: imob })} className="p-2 text-slate-500 hover:text-slate-800"><UsersIcon /></button>
                                            <button onClick={() => setFormModal({ isOpen: true, data: imob })} className="p-2 text-slate-500 hover:text-slate-800"><EditIcon /></button>
                                            <button onClick={() => setConfirmModal({ isOpen: true, data: imob })} className="p-2 text-red-500 hover:text-red-700"><TrashIcon /></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    <Modal isOpen={formModal.isOpen} onClose={() => setFormModal({ isOpen: false, data: null })}>
                        <ImobiliariaForm imobiliaria={formModal.data} onFormSubmit={handleFormSubmit} onCancel={() => setFormModal({ isOpen: false, data: null })} />
                    </Modal>
                    <ConfirmationModal 
                        isOpen={confirmModal.isOpen} 
                        onClose={() => setConfirmModal({ isOpen: false, data: null })}
                        onConfirm={handleDelete}
                        title="Apagar Imobiliária"
                        message={`Tem a certeza que quer apagar a imobiliária "${confirmModal.data?.imob_nome}"? Esta ação não pode ser desfeita.`}
                    />
                </div>
            );
        };

        const DashboardPage = ({ onEmpreendimentoClick }) => {
            const { user } = useAuth();
            if (user?.permissao === 'superadmin') return <SuperAdminDashboard />;
            return <ImobiliariaDashboard onEmpreendimentoClick={onEmpreendimentoClick} />;
        };

        // --- COMPONENTE PRINCIPAL (APP) ---
        const App = () => {
          const [currentPage, setCurrentPage] = React.useState('catalog');
          const [selectedEmpreendimento, setSelectedEmpreendimento] = React.useState(null);
          const { user, loading, logout } = useAuth();
          
          React.useEffect(() => {
            if (user) setCurrentPage('dashboard');
            else setCurrentPage('catalog');
          }, [user]);

          const handleLogout = () => {
            logout();
            setCurrentPage('catalog');
          };

          const renderPage = () => {
            switch (currentPage) {
              case 'login': return <LoginPage onLoginSuccess={() => setCurrentPage('dashboard')} />;
              case 'dashboard': return user ? <DashboardPage onEmpreendimentoClick={setSelectedEmpreendimento} /> : <LoginPage onLoginSuccess={() => setCurrentPage('dashboard')} />;
              case 'catalog': default: return <CatalogPage onEmpreendimentoClick={setSelectedEmpreendimento} />;
            }
          };
          
          if (loading) return <div className="min-h-screen bg-slate-100 flex items-center justify-center"><Spinner /></div>;

          return (
            <div className="bg-slate-100 min-h-screen">
              <header className="bg-white/80 backdrop-blur-lg sticky top-0 z-40 shadow-sm">
                <div className="container mx-auto px-4 py-3 flex justify-between items-center">
                  <div className="font-bold text-xl text-slate-800 cursor-pointer" onClick={() => setCurrentPage('catalog')}>
                    MIA<span className="font-normal text-slate-500"> Inteligencia Imobiliaria</span>
                  </div>
                  <nav>
                    {user ? (
                      <div className="flex items-center gap-4">
                        <span className="text-sm text-slate-600 hidden md:block">Olá, {user.usu_nome.split(' ')[0]}</span>
                        <Button onClick={() => setCurrentPage('dashboard')} variant="secondary">Meu Workspace</Button>
                        <Button onClick={handleLogout}>Sair</Button>
                      </div>
                    ) : <Button onClick={() => setCurrentPage('login')}>Login</Button>}
                  </nav>
                </div>
              </header>
              <main>{renderPage()}</main>
              <EmpreendimentoDetailModal isOpen={!!selectedEmpreendimento} onClose={() => setSelectedEmpreendimento(null)} empreendimento={selectedEmpreendimento} />
            </div>
          );
        };

        // O componente raiz que será renderizado
        ReactDOM.render(
            <AuthProvider>
                <App />
            </AuthProvider>,
            document.getElementById('root')
        );
    </script>
</body>
</html>
